# Generated by iptables-save v1.4.21 on {{ ansible_date_time['date'] }}
*mangle
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
COMMIT
# Completed on {{ ansible_date_time['date'] }}
# Generated by iptables-save v1.4.21 on {{ ansible_date_time['date'] }}
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
:sshguard - [0:0]
:TCP-FORWARD - [0:0]
:UDP-FORWARD - [0:0]
:TCP - [0:0]
:UDP - [0:0]
-A INPUT -j sshguard
-A FORWARD -j sshguard
-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A FORWARD -i lo -j ACCEPT
-A INPUT -m conntrack --ctstate INVALID -j DROP
-A FORWARD -m conntrack --ctstate INVALID -j DROP
-A INPUT -p icmp -m icmp --icmp-type 8 -m conntrack --ctstate NEW -j ACCEPT
-A FORWARD -p icmp -m icmp --icmp-type 8 -m conntrack --ctstate NEW -j ACCEPT

{% if 'FORWARD_4' in iptables %}
{% for d in iptables['FORWARD_4'] %}
-A FORWARD {% if 'ip4_src' in d %}-s {{ d.ip4_src }}{% endif %} {% if 'ip4_dst' in d %}-d {{ d.ip4_dst }}{% endif %} {% if 'iface_src' in d %}-i {{ d.iface_src }}{% endif %} {% if 'iface_dst' in d %}-o {{ d.iface_dst }}{% endif %} {% if 'port_src' in d %}--sport {{ d.port_src }}{% endif %} {% if 'port_dst' in d %}--dport {{ d.port_dst }}{% endif %} -j ACCEPT
{% endfor %}
{% endif %}
-A INPUT -p udp -m conntrack --ctstate NEW -j UDP
-A FORWARD -p udp -m conntrack --ctstate NEW -j UDP-FORWARD
-A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -m conntrack --ctstate NEW -j TCP
-A FORWARD -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -m conntrack --ctstate NEW -j TCP-FORWARD
-A INPUT -p udp -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -p udp -j REJECT --reject-with icmp-port-unreachable
-A INPUT -p tcp -j REJECT --reject-with tcp-reset
-A FORWARD -p tcp -j REJECT --reject-with tcp-reset
-A INPUT -j REJECT --reject-with icmp-proto-unreachable
-A FORWARD -j REJECT --reject-with icmp-proto-unreachable

{% if 'TCP' in iptables %}
{% for d in iptables['TCP'] %}
-A TCP -p tcp -m tcp {% if 'ip4_src' in d %}-s {{ d.ip4_src }}{% endif %} {% if 'ip4_dst' in d %}-d {{ d.ip4_dst }}{% endif %} {% if 'iface_src' in d %}-i {{ d.iface_src }}{% endif %} {% if 'iface_dst' in d %}-o {{ d.iface_dst }}{% endif %} {% if 'port_src' in d %}--sport {{ d.port_src }}{% endif %} {% if 'port_dst' in d %}--dport {{ d.port_dst }}{% endif %} -j ACCEPT
{% endfor %}
{% endif %}

{% if 'UDP' in iptables %}
{% for d in iptables['UDP'] %}
-A UDP -p udp -m udp {% if 'ip4_src' in d %}-s {{ d.ip4_src }}{% endif %} {% if 'ip4_dst' in d %}-d {{ d.ip4_dst }}{% endif %} {% if 'iface_src' in d %}-i {{ d.iface_src }}{% endif %} {% if 'iface_dst' in d %}-o {{ d.iface_dst }}{% endif %} {% if 'port_src' in d %}--sport {{ d.port_src }}{% endif %} {% if 'port_dst' in d %}--dport {{ d.port_dst }}{% endif %} -j ACCEPT
{% endfor %}
{% endif %}

{% if 'TCP_FORWARD' in iptables %}
{% for d in iptables['TCP_FORWARD'] %}
-A TCP-FORWARD -p tcp -m tcp {% if 'ip4_src' in d %}-s {{ d.ip4_src }}{% endif %} {% if 'ip4_dst' in d %}-d {{ d.ip4_dst }}{% endif %} {% if 'iface_src' in d %}-i {{ d.iface_src }}{% endif %} {% if 'iface_dst' in d %}-o {{ d.iface_dst }}{% endif %} {% if 'port_src' in d %}--sport {{ d.port_src }}{% endif %} {% if 'port_dst' in d %}--dport {{ d.port_dst }}{% endif %} -j ACCEPT
{% endfor %}
{% endif %}

{% if 'UDP_FORWARD' in iptables %}
{% for d in iptables['UDP_FORWARD'] %}
-A UDP-FORWARD -p udp -m udp {% if 'ip4_src' in d %}-s {{ d.ip4_src }}{% endif %} {% if 'ip4_dst' in d %}-d {{ d.ip4_dst }}{% endif %} {% if 'iface_src' in d %}-i {{ d.iface_src }}{% endif %} {% if 'iface_dst' in d %}-o {{ d.iface_dst }}{% endif %} {% if 'port_src' in d %}--sport {{ d.port_src }}{% endif %} {% if 'port_dst' in d %}--dport {{ d.port_dst }}{% endif %} -j ACCEPT
{% endfor %}
{% endif %}


COMMIT
# Completed on {{ ansible_date_time['date'] }}
# Generated by iptables-save v1.4.21 on {{ ansible_date_time['date'] }}
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]

{% if 'TCP_FORWARD' in iptables %}
{% for d in iptables['TCP_FORWARD'] %}
{% if not 'ip4_src' in d %}
-A PREROUTING -p tcp {% if 'ip4_src' in d %}-s {{ d.ip4_src }}{% endif %} {% if 'ip4_dst' in d %}-d {{ iptables['IP4_WAN'] }}{% endif %} {% if 'iface_src' in d %}-i {{ d.iface_src }}{% endif %} {% if 'iface_dst' in d %}-o {{ d.iface_dst }}{% endif %} {% if 'port_src' in d %}--sport {{ d.port_src }}{% endif %} {% if 'port_dst' in d %}--dport {{ d.port_dst }}{% endif %} -j DNAT --to {{ d.ip4_dst }}:{{ d.port_dst }}
{% endif %}
{% endfor %}
{% endif %}

{% if 'UDP_FORWARD' in iptables %}
{% for d in iptables['UDP_FORWARD'] %}
{% if not 'ip4_src' in d %}
-A PREROUTING -p udp {% if 'ip4_src' in d %}-s {{ d.ip4_src }}{% endif %} {% if 'ip4_dst' in d %}-d {{ iptables['IP4_WAN'] }}{% endif %} {% if 'iface_src' in d %}-i {{ d.iface_src }}{% endif %} {% if 'iface_dst' in d %}-o {{ d.iface_dst }}{% endif %} {% if 'port_src' in d %}--sport {{ d.port_src }}{% endif %} {% if 'port_dst' in d %}--dport {{ d.port_dst }}{% endif %} -j DNAT --to {{ d.ip4_dst }}:{{ d.port_dst }}
{% endif %}
{% endfor %}
{% endif %}


{% if 'TCP_FORWARD' in iptables %}
{% for d in iptables['TCP_FORWARD'] %}
{% if not 'ip4_src' in d %}
-A POSTROUTING -p tcp -d {{ d.ip4_dst }} -s {{  d.ip4_dst }} --dport {{ d.port_dst }} -j SNAT --to {{ iptables['IP4_WAN'] }}
{% endif %}
{% endfor %}
{% endif %}

{% if 'UDP_FORWARD' in iptables %}
{% for d in iptables['UDP_FORWARD'] %}
{% if not 'ip4_src' in d %}
-A POSTROUTING -p udp -d {{ d.ip4_dst }} -s {{  d.ip4_dst }} --dport {{ d.port_dst }} -j SNAT --to {{ iptables['IP4_WAN'] }}
{% endif %}
{% endfor %}
{% endif %}

{% if 'MASQUERADE' in iptables %}
{% for d in iptables['MASQUERADE'] %}
-A POSTROUTING {% if 'ip4_src' in d %}-s {{ d.ip4_src }}{% endif %} {% if 'ip4_dst' in d %}-d {{ d.ip4_dst }}{% endif %} {% if 'iface_src' in d %}-i {{ d.iface_src }}{% endif %} {% if 'iface_dst' in d %}-o {{ d.iface_dst }}{% endif %} {% if 'port_src' in d %}--sport {{ d.port_src }}{% endif %} {% if 'port_dst' in d %}--dport {{ d.port_dst }}{% endif %} -j MASQUERADE
{% endfor %}
{% endif %}
COMMIT
# Completed on {{ ansible_date_time['date'] }}
