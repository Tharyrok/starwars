server {
	listen 80;
	listen [::]:80;
	server_name {{ DOMAIN }};

	{% if SSL_UNIQ %}
        location / {
                return 301 https://$server_name$request_uri;
        }
	{% endif %}

	{% if PROXY %}
		{% if ansible_hostname | match('web') %}
			location / {
				proxy_pass        http://{{ PROXY_IP }};
				proxy_set_header Host $host;
				proxy_set_header X-Real-IP $remote_addr;
				proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
				proxy_set_header X-Forwarded-Proto $scheme;
			}

			location ^~ /.well-known/acme-challenge/ {
				allow all;
				alias /home/letsencrypt/webroot/;
				try_files $uri =404;
			}
		{% else %}
			{% if LE and not ansible_hostname | match('web') %}
				location ^~ /.well-known/acme-challenge/ {
					allow all;
					alias /home/letsencrypt/webroot/;
					try_files $uri =404;
				}
			{% endif %}
		{% endif %}
	{% else %}
		{% if LE %}
			location ^~ /.well-known/acme-challenge/ {
				allow all;
				alias /home/letsencrypt/webroot/;
				try_files $uri =404;
			}
		{% endif %}
	{% endif %}

	{% if not SSL_UNIQ and not PROXY and not PROXY_SSL %}
		{% include "commun.j2" %}
	{% endif %}

}


{% if SSL %}
server {
	listen 443 ssl http2;
	listen [::]:443 ssl http2;
	server_name {{ DOMAIN }};

	ssl_certificate /home/letsencrypt/bundles/{{ DOMAIN }}.pem;
	ssl_certificate_key /home/letsencrypt/ssl/{{ DOMAIN }}/{{ DOMAIN }}.key;
	{% if PROXY_SSL %}
		location / {
			proxy_pass        http://{{ PROXY_IP }};
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}
	{% else %}
		{% include "commun.j2" %}
	{% endif %}

}
{% endif %}
